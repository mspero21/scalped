/**
 * Geocode Stadiums Script
 *
 * This script fetches all stadiums from the database that don't have coordinates,
 * uses Nominatim geocoding API to get lat/lon, and updates the database.
 *
 * Usage: node scripts/geocode-stadiums.js
 */

require('dotenv').config({ path: '.env.local' });
const { createClient } = require('@supabase/supabase-js');

// Initialize Supabase client
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Missing Supabase credentials in .env.local');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Sleep function to respect API rate limits (1 request per second for Nominatim)
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function geocodeAddress(address) {
  try {
    const encodedAddress = encodeURIComponent(address);
    const url = `https://nominatim.openstreetmap.org/search?q=${encodedAddress}&format=json&limit=1`;

    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Scalped Stadium App (stadium geocoding)',
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();

    if (data && data.length > 0) {
      return {
        latitude: parseFloat(data[0].lat),
        longitude: parseFloat(data[0].lon),
      };
    }

    return null;
  } catch (error) {
    console.error(`Error geocoding "${address}":`, error.message);
    return null;
  }
}

async function geocodeStadiums() {
  console.log('üèüÔ∏è  Stadium Geocoding Script\n');
  console.log('Fetching stadiums without coordinates...\n');

  // Fetch all stadiums without coordinates
  const { data: stadiums, error } = await supabase
    .from('stadiums')
    .select('id, name, city, state, country')
    .or('latitude.is.null,longitude.is.null')
    .order('name');

  if (error) {
    console.error('‚ùå Error fetching stadiums:', error);
    process.exit(1);
  }

  if (!stadiums || stadiums.length === 0) {
    console.log('‚úÖ All stadiums already have coordinates!');
    process.exit(0);
  }

  console.log(`Found ${stadiums.length} stadiums without coordinates\n`);
  console.log('Starting geocoding (1 request per second)...\n');

  const results = {
    success: [],
    failed: [],
  };

  let sqlStatements = [];

  for (const [index, stadium] of stadiums.entries()) {
    const progress = `[${index + 1}/${stadiums.length}]`;

    // Construct search address
    const addressParts = [stadium.name, stadium.city, stadium.state, stadium.country].filter(Boolean);
    const address = addressParts.join(', ');

    console.log(`${progress} Geocoding: ${address}`);

    const coords = await geocodeAddress(address);

    if (coords) {
      // Update database
      const { error: updateError } = await supabase
        .from('stadiums')
        .update({
          latitude: coords.latitude,
          longitude: coords.longitude,
        })
        .eq('id', stadium.id);

      if (updateError) {
        console.log(`  ‚ùå Failed to update: ${updateError.message}`);
        results.failed.push({ stadium: stadium.name, reason: 'Database update failed' });
      } else {
        console.log(`  ‚úÖ Coordinates: ${coords.latitude}, ${coords.longitude}`);
        results.success.push(stadium.name);

        // Generate SQL statement for migration file
        sqlStatements.push(
          `UPDATE stadiums SET latitude = ${coords.latitude}, longitude = ${coords.longitude} WHERE id = '${stadium.id}'; -- ${stadium.name}`
        );
      }
    } else {
      console.log(`  ‚ùå No coordinates found`);
      results.failed.push({ stadium: stadium.name, reason: 'Geocoding failed' });
    }

    // Wait 1 second between requests to respect Nominatim rate limits
    if (index < stadiums.length - 1) {
      await sleep(1000);
    }
  }

  // Print summary
  console.log('\n' + '='.repeat(60));
  console.log('üìä GEOCODING SUMMARY');
  console.log('='.repeat(60));
  console.log(`‚úÖ Successfully geocoded: ${results.success.length}`);
  console.log(`‚ùå Failed: ${results.failed.length}`);

  if (results.failed.length > 0) {
    console.log('\n‚ùå Failed Stadiums:');
    results.failed.forEach(({ stadium, reason }) => {
      console.log(`   - ${stadium}: ${reason}`);
    });
  }

  // Write SQL migration file
  if (sqlStatements.length > 0) {
    const fs = require('fs');
    const path = require('path');

    const migrationContent = `-- Stadium Coordinates Migration
-- Generated by geocode-stadiums.js
-- Date: ${new Date().toISOString()}

${sqlStatements.join('\n')}
`;

    const migrationPath = path.join(__dirname, '../supabase/migrations/009_populate_stadium_coordinates.sql');
    fs.writeFileSync(migrationPath, migrationContent);
    console.log(`\nüìù SQL migration file created: ${migrationPath}`);
  }

  console.log('\n‚ú® Geocoding complete!');
}

// Run the script
geocodeStadiums().catch(error => {
  console.error('‚ùå Fatal error:', error);
  process.exit(1);
});
